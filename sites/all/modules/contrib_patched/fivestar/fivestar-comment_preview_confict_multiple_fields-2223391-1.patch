From 9f8dfe6d4be807829b16e5ca4d8b128d1d375bfb Mon Sep 17 00:00:00 2001
From: Ryan Jacobs <rjacobs@422459.no-reply.drupal.org>
Date: Fri, 21 Mar 2014 17:03:28 -0500
Subject: [PATCH] Issue #2223391 by rjacobs: Fixed comment preview conflict
 when multiple fivestar fields exist on commented entity.

---
 fivestar.module | 15 +++++++--------
 1 file changed, 7 insertions(+), 8 deletions(-)

diff --git a/fivestar.module b/fivestar.module
index 88b6cda..bdf3782 100644
--- a/fivestar.module
+++ b/fivestar.module
@@ -350,19 +350,18 @@ function fivestar_fivestar_access($entity_type, $id, $tag, $uid) {
  * suggestion by ChristianAdamski in issue 1289832-3.
  */
 function fivestar_form_comment_form_alter(&$form, &$form_state, $form_id) {
-  $is_fivestar = FALSE;
+  $fivestar_field_keys = array();
   if (isset($form['comment_output_below'])) {
     foreach($form['comment_output_below'] as $key => $value) {
-      if (is_array($value) && !empty($value['#field_type'])) {
-        if ($value['#field_type'] =='fivestar') {
-          $is_fivestar = TRUE;
-          $fivestar_key = $key;
-        }
+      if (is_array($value) && !empty($value['#field_type']) && $value['#field_type'] == 'fivestar') {
+        $fivestar_field_keys[] = $key;
       }
     }
   }
-  if ($is_fivestar) {
-    unset($form['comment_output_below'][$fivestar_key]);
+  if ($fivestar_field_keys) {
+    foreach ($fivestar_field_keys as $key) {
+      unset($form['comment_output_below'][$key]);
+    }
   }
 }
 
-- 
1.8.5.2 (Apple Git-48)

